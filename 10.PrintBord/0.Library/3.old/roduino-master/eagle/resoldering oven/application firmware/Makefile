##################################
## Makefile for project: ReflowToasterOven
## Generated by AVR Project IDE: http://code.google.com/p/avr-project-ide/
##################################

## General Flags
PROJECT = ReflowToasterOven
MCU = atmega32u4
BURNMCU = atmega32u4
BURNPROGRAMMER = avr109
OUTDIR = output
TARGET = $(OUTDIR)/$(PROJECT).elf
CC = avr-gcc
CCXX = avr-g++

## Flags common to C, ASM, and Linker
COMMON = -mmcu=$(MCU)

## Flags common to C only
CFLAGS = $(COMMON)
CONLYFLAGS = -std=gnu99
CFLAGS += -Wall -gdwarf-2 -Wl,-u,vfprintf -DF_CPU=8000000UL -Os -funsigned-char -funsigned-bitfields -fpack-struct -fshort-enums -ffunction-sections -fdata-sections
CFLAGS += -MD -MP -MT $(*F).o

## Flags common to ASM only
ASMFLAGS = $(COMMON)
ASMFLAGS += $(CFLAGS)
ASMFLAGS += -x assembler-with-cpp -Wa,-gdwarf2
ASMFLAGS += 

## Flags common to CPP/CXX only
CXXFLAGS = $(COMMON)
CXXFLAGS += $(CFLAGS)
CXXFLAGS += -std=c99

## Flags common to Linker only
LDFLAGS = $(COMMON)
LDFLAGS += -Wl,-Map=$(OUTDIR)/$(PROJECT).map
LDFLAGS += -Wl,--gc-sections
LDFLAGS += -Wl,-u,vfprintf -lprintf_flt -lm

## Flags for Intel HEX file production
HEX_FLASH_FLAGS = -R .eeprom -R .fuse -R .lock -R .signature

HEX_EEPROM_FLAGS = -j .eeprom
HEX_EEPROM_FLAGS += --set-section-flags=.eeprom="alloc,load"
HEX_EEPROM_FLAGS += --change-section-lma .eeprom=0 --no-change-warnings

## Include Directories
INCLUDES = -I"."

## Libraries
LIBS = -lc -lm -lprintf_flt

## Link these object files to be made
OBJECTS = ReflowToasterOven.o lcd.o temperaturemeasurement.o usb_serial.o menus.o nvm.o heatingelement.o

## Link objects specified by users
LINKONLYOBJECTS = 

## Compile

all: $(TARGET)

ReflowToasterOven.o: ./ReflowToasterOven.c
	 $(CC) $(INCLUDES) $(CFLAGS) $(CONLYFLAGS) -c  $<

lcd.o: ./lcd.c
	 $(CC) $(INCLUDES) $(CFLAGS) $(CONLYFLAGS) -c  $<

temperaturemeasurement.o: ./temperaturemeasurement.c
	 $(CC) $(INCLUDES) $(CFLAGS) $(CONLYFLAGS) -c  $<

usb_serial.o: ./usb_serial.c
	 $(CC) $(INCLUDES) $(CFLAGS) $(CONLYFLAGS) -c  $<

menus.o: ./menus.c
	 $(CC) $(INCLUDES) $(CFLAGS) $(CONLYFLAGS) -c  $<

nvm.o: ./nvm.c
	 $(CC) $(INCLUDES) $(CFLAGS) $(CONLYFLAGS) -c  $<

heatingelement.o: ./heatingelement.c
	 $(CC) $(INCLUDES) $(CFLAGS) $(CONLYFLAGS) -c  $<




$(OUTDIR):
	 mkdir $@


## Link
$(TARGET): $(OBJECTS) $(OUTDIR)
	-rm -rf $(TARGET) $(OUTDIR)/$(PROJECT).map
	 $(CC) $(LDFLAGS) $(OBJECTS) $(LINKONLYOBJECTS) $(LIBDIRS) $(LIBS) -o $(TARGET)
	-rm -rf $(OBJECTS) ReflowToasterOven.d lcd.d temperaturemeasurement.d usb_serial.d menus.d nvm.d heatingelement.d 
	-rm -rf $(OUTDIR)/$(PROJECT).hex $(OUTDIR)/$(PROJECT).eep $(OUTDIR)/$(PROJECT).lss
	avr-objcopy -O ihex $(HEX_FLASH_FLAGS) $(TARGET) $(OUTDIR)/$(PROJECT).hex
	avr-objcopy $(HEX_FLASH_FLAGS) -O ihex $(TARGET) $(OUTDIR)/$(PROJECT).eep || exit 0
	avr-objdump -h -S $(TARGET) >> $(OUTDIR)/$(PROJECT).lss
	@avr-size -C --mcu=${MCU} ${TARGET}

## Program
burn:
	avrdude -p $(BURNMCU) -c $(BURNPROGRAMMER) -P //./COM9 -U flash:w:$(OUTDIR)/$(PROJECT).hex:a 

burnfuses:
	avrdude -p $(BURNMCU) -c $(BURNPROGRAMMER) -P //./COM9-P //./COM9  

## Clean target
.PHONY: clean
clean:
	-rm -rf $(OBJECTS) ReflowToasterOven.d lcd.d temperaturemeasurement.d usb_serial.d menus.d nvm.d heatingelement.d  $(OUTDIR)/$(PROJECT).elf $(OUTDIR)/$(PROJECT).map $(OUTDIR)/$(PROJECT).lss $(OUTDIR)/$(PROJECT).hex $(OUTDIR)/$(PROJECT).eep $(OUTDIR)
